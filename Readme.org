#+STARTUP: showeverything

* Deploy
gcloud functions deploy download-stock \
--gen2 \
--region=asia-east2 \
--runtime=go120 \
--source=. \
--entry-point=DownloadStock \
--trigger-http \
--set-secrets='QUANDL_TOKEN=QUANDL_TOKEN:latest' \
--set-secrets='SLACK_WEBHOOK=SLACK_WEBHOOK:latest' \
--service-account='msa-download-stock@stock-lib.iam.gserviceaccount.com' \
--timeout=1800s \
--memory=256MB \
--max-instances=1

* Access
#+BEGIN_SRC bash
gcloud functions add-invoker-policy-binding download-stock \
    --region="asia-east2" \
    --member="user:billy.lamkc@gmail.com"
#+END_SRC



* Curl
** old
curl -m 70 -X POST https://download-stock-fogu52oorq-df.a.run.app \
-H "Authorization: bearer $(gcloud auth print-identity-token)" \
-H "Content-Type: application/json" \
-d '{
  "name": "Hello World"
}'


** new
curl -m 1810 -X POST https://asia-east2-stock-lib.cloudfunctions.net/download-stock \
-H "Authorization: bearer $(gcloud auth print-identity-token)" \
-H "Content-Type: application/json" \
-d '{
  "name": "Hello World"
}'



* Running
** Reference
https://github.com/GoogleCloudPlatform/functions-framework-go#quickstart-hello-world-on-your-local-machine

** Run
export FUNCTION_TARGET=DownloadStock
go runsudo apt-get install google-cloud-sdk-cloud-run-proxy cmd/main.go

curl localhost:8080


* setup
** service account
gcloud iam service-accounts create msa-download-stock \
    --display-name="Managed service account - Download Stock" \
    --description="Managed service account - Download Stock"

** Create custome role
*** Reference
Ref: [[https://stackoverflow.com/questions/59756793/how-do-i-grant-a-specific-permission-to-a-cloud-iam-service-account-using-the-gc][grant a specific permission]]
Ref: [[https://cloud.google.com/iam/docs/creating-custom-roles][Create custom role]]

*** Commands
gcloud iam roles create cloud-func-member \
    --project stock-lib \
    --title "General role for cloud functions" \
    --description "General role for cloud functions" \
    --permissions storage.buckets.get


gcloud iam roles create cloud_func_member --project=stock-lib \
    --file=custom-role.yaml


** Grant Custom role
gcloud projects add-iam-policy-binding stock-lib \
  --member='serviceAccount:test-proj1@example.domain.com' \
  --role='projects/example-project-id-1/roles/bucketViewer'

** Grant invoker role
gcloud functions add-iam-policy-binding download-stock \
  --member="billy.lamkc@gmail.com" \
  --role="roles/run.invoker" \
  --region="asia-east2"


gcloud functions add-invoker-policy-binding download-stock \
  --region="asia-east2" \
  --member="user:billy.lamkc@gmail.com"
